#!/usr/bin/env sh

BASEDIR=`dirname $0`
if ! . $BASEDIR/lib/util.sh; then
  echo "FATAL: error sourcing $BASEDIR/lib/util.sh" 1>&2
  exit 99
fi

if [ "$1" == "-r" ]; then
  shift
  ./rebuild $@ || exit $?
fi

DBNAME=`psql -qtc 'SELECT current_database()' $@` || exit $?
TEST_SCHEMA_SQL=\
"SELECT nspname
	FROM
		pg_namespace n
	WHERE nspname LIKE '_test%'
		AND EXISTS( SELECT 1 FROM pg_proc WHERE pronamespace = n.oid )
;"


for schema in $TEST_SCHEMAS; do
  PGOPTIONS="-c search_path=tap" pg_prove --trap --state hot,all,save --failures --runtests --match '^[^_]' --jobs 9 --schema $schema -d $@
done

# vi: expandtab sw=2 ts=2
